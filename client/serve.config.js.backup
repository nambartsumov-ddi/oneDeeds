const serve = require('webpack-serve');
const argv = {};
const config = require('./webpack.config.js');

const history = require('connect-history-api-fallback');
const convert = require('koa-connect');

serve(argv, { config }).then((serveResult) => {
  console.log(serveResult);
  serveResult.options.port = 3000;
  serveResult.options.hmr = true;
  serveResult.options.open = true;
  console.log(serveResult);

  serveResult.options = {
    add: (app, middleware, options) => {
      // app.use(convert(proxy('/api', { target: 'http://localhost:8081' })));

      // HistoryApiFallback
      const historyOptions = {
        // ... see: https://github.com/bripkens/connect-history-api-fallback#options
      };
      app.use(convert(history(historyOptions)));
    },
  };
});

// This add-on will route all incoming requests for
// "http://localhost:8080/api/*" to "http://localhost:8081/api/*" (note the port
// change), and all remaining requests, which would otherwise result in 404,
// will be rewritten to serve your "index.html", which is useful for single-page
// applications.
//
// To remove the "/api" prefix when proxying the API requests, just add
// "pathRewrite: { '^/api': '' }" to proxy's options.
//
// Proxy's docs: https://github.com/chimurai/http-proxy-middleware
// Fallback's docs: https://github.com/bripkens/connect-history-api-fallback
